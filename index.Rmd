---
title: "TeviHub"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    theme: flatly
    logo: images/SWEEPLOGO.png
    author: "Jonathan Mosedale"
---
<script>
$('.navbar-logo').wrap('<a href="http://www.sweep.ac.uk"> target=_blank');
</script>

```{r, setup, include=FALSE}
##### TO render whole site run line command:
#   rmarkdown::render_site()
#   https://jrmosedale.github.io/dashboard/

# Linking multiple Rmd files - usew either bookdown or child files - reF:https://stackoverflow.com/questions/25824795/how-to-combine-two-rmarkdown-rmd-files-into-a-single-output

#  devtools::install_github("walkerke/bsselectR")

library(flexdashboard)
library(bsselectR)
library(raster)
library(leaflet)
library(magrittr)
library(colorspace)
library(rgeos)
library(ggplot2)
library(rgdal)
library(sf)
library(units)
library(leaflet.extras)
library(htmlwidgets)
library(zonator)
library(RColorBrewer)
library(DT)

#### iframe refs: https://stackoverflow.com/questions/15255858/set-the-iframe-height-automatically
### https://stackoverflow.com/questions/44371799/how-can-i-insert-html-widget-objects-leaflet-map-or-html-table-in-an-html-mark

################################################
# Directories
###############################################
# if (Sys.getenv("HOME")=="/Users/jm622") in.root<-paste0(Sys.getenv("HOME"),"/OneDrive - University of Exeter/Rprojects/EG4B/app/")
in.root<-"data/"
dir_cna<-paste0(in.root,"cnamaps/")
#dir_ZProject<-paste0("/Volumes/Pocket_Sam/data/Zonation_Projects/Cornwall_Priority/")
#dir_zinputs<-"/Volumes/Pocket_Sam/data/Zonation_data/"

################################################
# Load functions 
###############################################
source("Rscripts/functions.R")

# Presentation functions etc
csa_icons <- function() {
  awesomeIcons(
  icon = 'ios-close',
  iconColor = 'black',
  library = 'ion',
  markerColor = "green")
}

cta_icons<- function() {
  awesomeIcons(
    icon = 'ios-close',
    iconColor = 'black',
    library = 'ion',
    markerColor = "blue"
  )
}

tevi_icons <- function(tevibus){
  awesomeIcons(
    icon = tevibus$Icon,
    iconColor = 'black',
    library = 'fa',
    markerColor = tevibus$Colour
  )
}

zero_to_NA<-function(r){
  result<-calc(r,fun=function(x){ifelse(x==0,NA,x)})
  return(result)
}

# Recalculating rank after masking
rank_after_mask<-function(r,msk){
  msk.cells<-getValues(mask(r,msk))
  min.prot<-min(msk.cells,na.rm=TRUE)
  # num.prot<-length(msk.cells[-which(is.na(msk.cells))])
  rem.cells<-getValues(mask(r,msk,inverse=TRUE))
  max.rem<-max(rem.cells,na.rm=TRUE)
  new.ranks<-(rem.cells/max.rem)*1
  new.r<-setValues(r,new.ranks)
  return(new.r)
}

```

A. Business Engagement 
============================================================================================

Column {.tabset data-width=800}
------------------------------------------------------------------------------------------------------------
### Map 1 Tevi Businesses

```{r,context='data', include=FALSE}

############################################
# LOAD Business data and prepare for mapping
############################################

# Business data
tevibus<- st_read(paste0(in.root,"tevibus.shp"))
csawinners<-st_read(paste(in.root,"csawinners.shp",sep=""))
cta2018<- st_read(paste0(in.root,"cta2018.shp"))
st_crs(tevibus)<-st_crs(27700)
st_crs(csawinners)<-st_crs(27700)
st_crs(cta2018)<-st_crs(27700)

```


```{r,echo=FALSE,out.width='100%', fig.align='center'}

# Create popup message
tevi.popup<-paste("<b>",tevibus$Enterprise,"</b>","<br>","Sector: ",tevibus$Sector,"<br>","Tevi Status: ",tevibus$Status,"<br>") 

teviplot<- prepare_sf_for_leaflet(tevibus)

leaflet() %>% 
  setView(lng = -4.9, lat = 50.4, zoom = 10)  %>%
  addProviderTiles("OpenStreetMap.Mapnik") %>%
  addScaleBar() %>%
  addAwesomeMarkers(data=teviplot,
                    icon=tevi_icons(teviplot),  
                    label = ~as.character(Enterprise),
                    popup = tevi.popup
)


```

### Map 2 Cornwall Sustainability and Tourism Award Winners

```{r,  echo=FALSE}
# Create popup message
csa.popup<-paste("<b>",csawinners$Business,"</b>","-",csawinners$Award,csawinners$Year)
cta.popup<-paste("<b>",cta2018$Enterprise,"</b>","-",cta2018$Award,cta2018$Year)


leaflet() %>% 
setView(lng = -4.9, lat = 50.4, zoom = 10)  %>%
addProviderTiles("OpenStreetMap.Mapnik") %>%
addScaleBar() %>%
addAwesomeMarkers(data=prepare_sf_for_leaflet(csawinners),
                  icon=csa_icons(), 
                  label = ~as.character(Business),
                  popup = csa.popup,
                  group= "CSA businesses")  %>%
addAwesomeMarkers(data=prepare_sf_for_leaflet(cta2018),
                  icon=cta_icons(), 
                  label = ~as.character(Enterprise),
                  popup = cta.popup,
                  group ="CTA businesses" )  %>%
addLayersControl(
                  overlayGroups =c("CSA businesses", "CTA businesses"),
                  options = layersControlOptions(collapsed=FALSE)  
)  %>%
hideGroup(c("CTA businesses"))


```

Column {.tabset data-width=200}
------------------------------------------------------------------------------------------------------------
  
   
*__Map 1:__* Businesses participating (as of January 2019) in the [Tevi](https://tevi.co.uk) programme.  

  
*__Map 2:__* Business award winners of the [Cornwall Sustainability Awards](https://www.cornwallsustainabilityawards.org) (2004-17) and [Cornwall Tourism Awards](http://www.cornwalltourismawards.org.uk) (2018 only).  
  
  
Click on markers for further information.  


B. Ecosystem Services 
============================================================================================

Column {.tabset}
------------------------------------------------------------------------------------------------------------

### Maps of Services
```{r,context='data', include=FALSE}

# Load service rasters and determine palette for each

# Soil loss mitigation
soilmitig.r<-raster(paste0(in.root,"ecoservices/ecoservice_soillossmitig.tif"))
crs(soilmitig.r)<- CRS('+init=EPSG:27700')
soilmitig.vals<-getValues(soilmitig.r)

# Aboveground carbon 
abovecarbon.r<-raster(paste0(in.root,"ecoservices/ecoservice_aboveground_carbon.tif"))
crs(abovecarbon.r)<- CRS('+init=EPSG:27700')
abovecarbon.vals<-getValues(abovecarbon.r)

# Pollination 
pollination.r<-raster(paste0(in.root,"ecoservices/ecoservice_pollination.tif"))
crs(pollination.r)<- CRS('+init=EPSG:27700')
pollination.vals<-getValues(pollination.r)

# Flood mitigation
floodmitig.r<-raster(paste0(in.root,"ecoservices/ecoservice_floodmitig.tif"))
crs(floodmitig.r)<- CRS('+init=EPSG:27700')
floodmitig.vals<-getValues(floodmitig.r)

# Drinking water quality
drinkqual.r<-raster(paste0(in.root,"ecoservices/ecoservice_drinkwater.tif"))
crs(drinkqual.r)<- CRS('+init=EPSG:27700')
drinkqual.vals<-getValues(drinkqual.r)

# Aquaculture water quality
aquaqual.r<-raster(paste0(in.root,"ecoservices/ecoservice_aquaculture.tif"))
crs(aquaqual.r)<- CRS('+init=EPSG:27700')
aquaqual.vals<-getValues(aquaqual.r)

# Bathing water quality 
bathqual.r<-raster(paste0(in.root,"ecoservices/ecoservice_bathingwater.tif"))
crs(bathqual.r)<- CRS('+init=EPSG:27700')
bathqual.vals<-getValues(bathqual.r)

# Not good catchments water quality 
catchqual.r<-raster(paste0(in.root,"ecoservices/ecoservice_catchmentquality.tif"))
crs(catchqual.r)<- CRS('+init=EPSG:27700')
catchqual.vals<-getValues(catchqual.r)

#servicepal<-colorBin("Greens", domain = NULL, bins = 7, na.color = "transparent")
servicepal<-colorNumeric("YlOrRd", domain = NULL,  na.color = "transparent")

```

```{r,  echo=FALSE}

leaflet() %>% 
  setView(lng = -4.9, lat = 50.4, zoom = 10)  %>%
  addProviderTiles("OpenStreetMap.Mapnik") %>%
  addScaleBar() %>%
  addRasterImage(abovecarbon.r, colors=servicepal,
               opacity = 0.8,project=TRUE, group="Aboveground_carbon") %>%
  addRasterImage(pollination.r, colors=servicepal,
               opacity = 0.8,project=TRUE, group="Pollination") %>%
  addRasterImage(soilmitig.r, colors=servicepal,
               opacity = 0.8,project=TRUE, group="Soil_loss_mitigation") %>%
  addRasterImage(floodmitig.r, colors=servicepal,
               opacity = 0.8,project=TRUE, group="Flood_mitigation") %>%
  addRasterImage(drinkqual.r, colors=servicepal,
               opacity = 0.8,project=TRUE, group="Drinking_water") %>%
  addRasterImage(aquaqual.r, colors=servicepal,
               opacity = 0.8,project=TRUE, group="Aquaculture") %>%
  addRasterImage(bathqual.r, colors=servicepal,
               opacity = 0.8,project=TRUE, group="Bathing_water") %>%
  addLegend(position = "bottomright",
            pal=servicepal, values=0:100,opacity=1) %>%

  addLayersControl(
    baseGroups =c("Aboveground_carbon","Pollination","Soil_loss_mitigation",
                     "Flood_mitigation","Drinking_water","Aquaculture","Bathing_water"),
    options = layersControlOptions(collapsed=FALSE)  )  %>%
  
  hideGroup(c("Pollination","Soil_loss_mitigation",
             "Flood_mitigation","Drinking_water","Aquaculture","Bathing_water"))

```


C. Nature network mapping 
============================================================================================

Column {.tabset }
------------------------------------------------------------------------------------------------------------

### Nature network map     
   
```{r, echo=FALSE}
prot.map1.filename<-paste0("maps/","protect/protect_map_v25.html")

htmltools::tags$iframe(src = prot.map1.filename, frameborder="1", style="overflow: hidden; height: 100%; width: 80%; position: absolute;")

```

```{r, echo=FALSE}
maptext.filename<-paste0("documentation/","NatureNetworkMap_text.html")

htmltools::tags$iframe(src = maptext.filename, frameborder="1", style="overflow: hidden; height: 100%; width: 20%; float: right")

```


### Method notes
```{r,echo=FALSE }

natnetwork.doc<-paste0("documentation/","NatureNetworkMap_documentation.html")

htmltools::tags$iframe(src = natnetwork.doc, frameborder="1", style="overflow: hidden; height: 100%; width: 100%; position: absolute;")
```

### Weight Table
```{r,echo=FALSE }

natnetwork_weights.doc<-paste0("documentation/","NatureNetworkMap_weightings.html")

htmltools::tags$iframe(src = natnetwork_weights.doc, frameborder="1", style="overflow: hidden; height: 100%; width: 100%; position: absolute;")
```



D. Opportunity mapping 
============================================================================================

Column {.tabset}
------------------------------------------------------------------------------------------------------------

```{r,context='data', include=FALSE}
woodopp.data.df<-read.csv("data/documentation/woodland_data_table.csv" ,header=TRUE,stringsAsFactors=FALSE, na.strings = "") 

```

### Woodland opportunity map

```{r, echo=FALSE}

opp.map1.filername<-paste0("maps/","opps/opp_woodland_map_v16.html")

htmltools::tags$iframe(src = opp.map1.filername, frameborder="1", style="overflow: hidden; height: 100%; width: 80%; position: absolute;")

```

```{r, echo=FALSE}
woodmaptext.filename<-paste0("documentation/","WoodlandOpportunityMap_text.html")

htmltools::tags$iframe(src = woodmaptext.filename, frameborder="1", style="overflow: hidden; height: 100%; width: 20%; float: right")

```


### Method Notes
```{r, echo=FALSE}

woodopp.doc<-paste0("documentation/","WoodOpp_maps_documentation.html")

htmltools::tags$iframe(src = woodopp.doc, frameborder="1", style="overflow: hidden; height: 100%; width: 100%; position: absolute;")


```

### Weightings
```{r, echo=FALSE}

```

### Recent Developments

**March 2019**   
  
*__Excluding woodland from potential heather and moorland opportunity sites__* - early woodland opportunity maps identified several (generally degraded) areas of moorland  as potential woodland opportunities. For example St Breock down area was frequently identified. In general such areas could be distinguished by very acid soils, but such a definition would exclude areas of alkali moorland on the Lizard.  
We will therefore adopt the Rural Payment's Agency 'moorline' that corresponds to 'land that is predominantly semi-nartural upland vegetation or rock outcrops used primarily for rough grazing'.  Woodland opportunities are entirely excluded from these areas as they are expected to be the focus of an alternative opportunity layer focussing on heather and moorland restoration.  
  
*__Active china clay and quarrying sites__* - we have currently excluded China Clay sites from consideration in the woodland opportunity map. However, it is several other active quarying sites are currently featuring in the opportunity map,for example, Delabole slate quarry. The extent of active quarrying at such sites can vary considerably and does not always correspond well with mapped quarry demarcations. Without any obvious data source available to idetnfiy active areas, we will exclude such sites on an ad-hic basis using aerial phtography (predoimnantly dating from 2015 or earlier).  

  

D. Area maps
============================================================================================
This section is currently UNDER DEVELOPMENT

Column {.tabset}
------------------------------------------------------------------------------------------------------------

### Community Network Areas

```{r,context='data', include=FALSE}
############################################
# LOAD Parish areas
############################################


############################################
# LOAD Community network areas
############################################

# Create list of files names
cna.shp<-st_read(paste0(in.root,"community_network_areas.shp"))
st_crs(cna.shp)<-st_crs(27700)
cna.shp<-st_transform(cna.shp,4326)
cna.names<-paste0(cna.shp$NAME)
cna.names<-sort(cna.names)

cna.list<-list.files("maps/")
cna.list<-sort(cna.list)
cna.list<-paste0("maps/",cna.list)
names(cna.list)<-cna.names

```

```{r,  echo=FALSE}

bsselect(cna.list, type = "iframe")

```


### Parishes


### Catchments


### Explanatory notes
Some sort of explanation and/or legend could be placed here, perhaps including links to a methodology document etc?

E. Contact
============================================================================================

For further information, questions or suggestions please contact:  
J.Mosedale@exeter.ac.uk 